<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title> Select Multi-Opions Experiment </title>

    <script src="js/jspsych/jspsych.js"></script>
    <script src="js/jspsych/plugin-html-button-response.js"></script>
    <script src="js/jspsych/plugin-instructions.js"></script>
    <script src="js/jspsych/plugin-image-keyboard-response.js"></script>
    <script src="js/jspsych/plugin-html-keyboard-response.js"></script>
    <script src="js/jspsych/plugin-preload.js"></script>
    <script src="js/jspsych/plugin-survey-html-form.js"></script>

    <script src="js/plugin-multi_select/plugin-select-multiple-buttons.js"></script>
    <script src="js/jspsych/utils.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.2.1/math.js"></script>

    <script src="js/jspsych/plugin-webgazer-calibrate.js"></script>
    <script src="js/jspsych/plugin-webgazer-init-camera.js"></script>
    <script src="js/jspsych/plugin-webgazer-validate.js"></script>
    <script src="js/jspsych/extension-webgazer.js"></script>
    <script src="js/node_modules/webgazer/dist/webgazer.js"></script>

    <link href="css/jspsych.css" rel="stylesheet" type="text/css" />

    <style>

    .jspsych-multiple-select-response-button {
        float: center;
        border: 4px
        solid #FFFFFF;
        cursor: pointer;
        width: 130px;
        padding: 1px;
        margin-bottom: 10px;
    }
    .active {
        border: 4px
        solid #FFFF00;
        background: #eeeeee;
        pointer-events: none;
    }
    /* Clear floats after image containers */
    .jspsych-multiple-select-response-button::after {
        content: "";
        clear: both;
        display: table;
    }
    </style>

</head>

<body>
</body>

<script>
var jsPsych = initJsPsych({
    extensions: [
          {type: jsPsychExtensionWebgazer}
      ],
    on_finish: function () {
        jsPsych.data.displayData()
    }
}
);

// eye tracking
// eye instructions
var camera_instructions = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
    <p>In order to participate you must allow the experiment to use your camera.</p>
    <p>You will be prompted to do this on the next screen.</p>
    <p>If you do not wish to allow use of your camera, you cannot participate in this experiment.<p>
    <p>It may take up to 30 seconds for the camera to initialize after you give permission.</p>
    `,
    choices: ['Got it'],
}
// initialize eye tracker
var init_camera = {
  type: jsPsychWebgazerInitCamera
}
// Calibration eye tracking
var calibration_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <p>Now you'll calibrate the eye tracking, so that the software can use the image of your eyes to predict where you are looking.</p>
    <p>You'll see a series of dots appear on the screen. Look at each dot and click on it.</p>
  `,
  choices: ['Got it'],
}
var calibration = {
   type: jsPsychWebgazerCalibrate,
   calibration_points: [
     [25,25],[75,25],[50,50],[25,75],[75,75]
   ],
   repetitions_per_point: 2,
   randomize_calibration_order: true
 }
 // validation eye tracking
 var validation_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <p>Now we'll measure the accuracy of the calibration.</p>
    <p>Look at each dot as it appears on the screen.</p>
    <p style="font-weight: bold;">You do not need to click on the dots this time.</p>
  `,
  choices: ['Got it'],
  post_trial_gap: 1000
}
var validation = {
  type: jsPsychWebgazerValidate,
  validation_points: [
    [25,25],[75,25],[50,50],[25,75],[75,75]
  ],
  roi_radius: 200,
  time_to_saccade: 1000,
  validation_duration: 2000,
  data: {
    task: 'validate'
  }
}
// recalibrate eye tracking
var recalibrate_instructions = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <p>The accuracy of the calibration is a little lower than we'd like.</p>
    <p>Let's try calibrating one more time.</p>
    <p>On the next screen, look at the dots and click on them.<p>
  `,
  choices: ['OK'],
}
var recalibrate = {
  timeline: [recalibrate_instructions, calibration, validation_instructions, validation],
  conditional_function: function(){
    var validation_data = jsPsych.data.get().filter({task: 'validate'}).values()[0];
    return validation_data.percent_in_roi.some(function(x){
      var minimum_percent_acceptable = 50;
      return x < minimum_percent_acceptable;
    });
  },
  data: {
    phase: 'recalibration'
  }
}
var calibration_done = {
  type: jsPsychHtmlButtonResponse,
  stimulus: `
    <p>Great, we're done with calibration!</p>
  `,
  choices: ['OK']
}
//Creating list of image paths to load.
//These are image paths to images for the experimental treatment shown on each trial
var image_indices_lst = math.range(1, 80); //math.range() returns a js obj that has a parameter called '._data' and that has an Array of the range.

image_indices_lst = Array.from(image_indices_lst._data); // This is just a list containing the range of numbers used for each url of the
// experimental stimulus. The experimental stimuli are all saved in the /img/food/ folder. They have a prefix "food"
// and then they include the number 1-N for N number of trials.
var arrayLength = image_indices_lst.length; // arrayLength is used to show how many images/trials there are from 1-N trials.
var image_paths = [];
for (var i = 0; i < arrayLength; i++) {
    // This for loop fills the image_paths list with urls to the images for each of the experimental treatments
    var path_str1 = "img/food/food" + String(image_indices_lst[i]) + ".jpg";
    image_paths.push(path_str1);
}

// Preloading files are needed to present the stimuli accurately.
const preload = {
    type: jsPsychPreload,
    images: image_paths,
}
const shuffled_image_names = jsPsych.randomization.shuffle(image_paths);
const trial_options = shuffled_image_names.slice(0, 15);

var factors = {
    image: shuffled_image_names,
};

var factorial_values = jsPsych.randomization.factorial(factors);

var fixation = {
    data: {screen_id: "fixation"},
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<div style='font-size: 60px'>+</div>",
    trial_duration: [500],
    response_ends_trial: false
};
var trial = {
    data: {
        screen_id: "trial",
        options: trial_options
    },
    type: jsPsychMutipleButtonResponse,
    stimulus: [],
    prompt: [],
    choices: [shuffled_image_names[0],
    shuffled_image_names[1],
    shuffled_image_names[2],
    shuffled_image_names[3],
    shuffled_image_names[4],
    shuffled_image_names[5],
    shuffled_image_names[6],
    shuffled_image_names[7],
    shuffled_image_names[8],
    shuffled_image_names[9],
    shuffled_image_names[10],
    shuffled_image_names[11],
    shuffled_image_names[12],
    shuffled_image_names[13],
    shuffled_image_names[14]
],
button_html: [
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-0">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-1">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-2">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-3">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-4">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-5">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-6">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-7">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-8">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-9">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-10">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-11">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-12">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-13">',
    '<img src="%choice%" style="width:128px;height:128px;display:table;", id="jspsych-html-button-response-button-14">'                    ],
    response_ends_trial: true,
    keys: ' ',
    margin_vertical: "40px",
    margin_horizontal: "50px",
    on_finish: function(data) {
        //count how many options where selected
        //count how many objects in the res_buttons arrary.
        //Its a string, so extract the numbers then count
        matches = data.res_buttons.match(/\d+/g);
        data.options_selected = matches.length
    },
    extensions: [
          {
            type: jsPsychExtensionWebgazer,
            params: {
                targets:
                ['#jspsych-multiple-select-response-button-0',
                '#jspsych-multiple-select-response-button-1',
                '#jspsych-multiple-select-response-button-2',
                '#jspsych-multiple-select-response-button-3',
                '#jspsych-multiple-select-response-button-4',
                '#jspsych-multiple-select-response-button-5',
                '#jspsych-multiple-select-response-button-6',
                '#jspsych-multiple-select-response-button-7',
                '#jspsych-multiple-select-response-button-8',
                '#jspsych-multiple-select-response-button-9',
                '#jspsych-multiple-select-response-button-10',
                '#jspsych-multiple-select-response-button-11',
                '#jspsych-multiple-select-response-button-12',
                '#jspsych-multiple-select-response-button-13',
                '#jspsych-multiple-select-response-button-14'
        ]}
          }
        ]
};

var trials_with_variables = {
    timeline: [fixation, trial],
    // timeline_variables: factorial_values
};

// timeline
var timeline = []
timeline.push(preload);
timeline.push(camera_instructions);
timeline.push(init_camera);
timeline.push(calibration_instructions);
timeline.push(calibration);
timeline.push(validation_instructions);
timeline.push(validation);
timeline.push(recalibrate);
timeline.push(calibration_done);
timeline.push(trials_with_variables);

//Start Experiment
jsPsych.run(timeline);

</script>
</html>
